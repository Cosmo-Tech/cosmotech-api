name: Lint

on:
  workflow_dispatch:
  push:
    branches:
      - main
    tags:
      - '*'
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [ main ]

jobs:
  spotless:
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
    - uses: actions/checkout@v2.3.4

    - name: Set up JDK
      uses: actions/setup-java@v2
      with:
        distribution: 'adopt'
        java-version: '16'
        cache: 'gradle'

    - name: Check with Spotless
      run: ./gradlew --info spotlessCheck

    # The OpenAPI Generator Gradle Plugin exposes an 'openApiValidate' task,
    # but at this time, it does not work with Gradle 7.0.
    # See https://github.com/OpenAPITools/openapi-generator/issues/9328
    # A separate dedicated job is available in the 'openapi.yml' Workflow
  #    - name: Validate OpenAPI spec definitions
#      run: ./gradlew openApiValidate --info

  detekt:
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - uses: actions/checkout@v2.3.4

      - name: Set up JDK
        uses: actions/setup-java@v2
        with:
          distribution: 'adopt'
          java-version: '16'
          cache: 'gradle'

      - name: Check with Detekt
        run: ./gradlew --info detekt

      - name: Upload SARIF reports to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v1
        if: ${{ always() }}
        with:
          sarif_file: 'build/reports/detekt/sarif/'

  helm-lint:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2.3.4

      - name: Set up Helm
        uses: azure/setup-helm@v1.1
        with:
          version: v3.6.0

      - name: Lint Helm Chart (api) with helm
        run: helm lint api/kubernetes/helm-chart

      - name: Lint Helm Chart (csm-argo)
        run: helm lint api/kubernetes/csm-argo

  kube-linter:
    runs-on: ubuntu-latest
    # TODO Errors purposely ignored for now.
    continue-on-error: true

    steps:
      - uses: actions/checkout@v2.3.4

      - uses: actions/setup-go@v2.1.4
        with:
          go-version: '^1.17'

      - run: go version

      # Needed as the SARIF format is not supported via the KubeLinter GitHub Action
      # Maybe open an issue in KubeLinter Action ?
      - name: Download KubeLinter
        env:
          GO111MODULE: 'on'
        run: go install golang.stackrox.io/kube-linter/cmd/kube-linter@latest

      - run: kube-linter version

      - run: mkdir -p api/kubernetes/.sarif

      - name: Lint Helm Chart (api) with KubeLinter
        # TODO Errors purposely ignored for now.
        run: |
          kube-linter \
            --config api/kubernetes/.kube-linter.yaml \
            lint \
            --format sarif \
            api/kubernetes/helm-chart \
          | jq | tee api/kubernetes/.sarif/helm-chart.sarif || true

      # This is needed because the Helm Chart name does not match the folder name.
      # Maybe open an issue in KubeLinter ?
      - name: Fix artifact location URI in the SARIF reports (api)
        if: ${{ always() }}
        run: |
          sed -i 's/api\/kubernetes\/cosmotech-api\//api\/kubernetes\/helm-chart\//g' \
            api/kubernetes/.sarif/helm-chart.sarif

      - name: Lint Helm Chart (csm-argo) with KubeLinter
        # TODO Errors purposely ignored for now.
        run: |
          kube-linter \
            --config api/kubernetes/.kube-linter.yaml \
            lint \
            --format sarif \
            api/kubernetes/csm-argo \
          | jq | tee api/kubernetes/.sarif/csm-argo.sarif || true

      - name: Upload SARIF reports to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v1
        if: ${{ always() }}
        with:
          sarif_file: 'api/kubernetes/.sarif/'
